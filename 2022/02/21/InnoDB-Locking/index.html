<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="chaoqiang.qiu">
    
    <title>
        
            InnoDB Locking |
        
        进击的阿强
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"chaoqiang6.github.io","root":"/","language":"zh-CN","path":"search.xml"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":true},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 6.0.0"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                进击的阿强
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">InnoDB Locking</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">chaoqiang.qiu</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2022-02-21 17:37:52</span>
        <span class="mobile">2022-02-21 17:37</span>
    </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/MySQL/">MySQL</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/InnoDB/">InnoDB</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E4%BA%8B%E5%8A%A1/">事务</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/%E9%94%81%E6%9C%BA%E5%88%B6/">锁机制</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p><a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/innodb-locking.html">InnoDB锁文档<i class="fas fa-external-link-alt"></i></a></p>
<blockquote>
<p>InnoDB支持事务，事务有四大特性，原子性，一致性，隔离性，持久性，事务有四种隔离级别:Read Uncommitted,READ COMMITTED,REPEATABLE_REaD,SERIALIZABLE,本文主要对InnoDB锁机制官网文档进行翻译，并解释MYSQL是如何在REPEATABLE隔离级别上达到SERIALIZABLE效果的</p>
</blockquote>
<h1 id="相关文档"><a href="#相关文档" class="headerlink" title="相关文档"></a>相关文档</h1><h2 id="InnoDB-Locking"><a href="#InnoDB-Locking" class="headerlink" title="InnoDB Locking"></a>InnoDB Locking</h2><p>This section describes lock types used by <code>InnoDB</code>.</p>
<ul>
<li>[Shared and Exclusive Locks](#Shared and Exclusive Locks)</li>
<li><a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-intention-locks">Intention Locks<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-record-locks">Record Locks<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-gap-locks">Gap Locks<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-next-key-locks">Next-Key Locks<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-insert-intention-locks">Insert Intention Locks<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-auto-inc-locks">AUTO-INC Locks<i class="fas fa-external-link-alt"></i></a></li>
<li><a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-predicate-locks">Predicate Locks for Spatial Indexes<i class="fas fa-external-link-alt"></i></a></li>
</ul>
<h4 id="Shared-and-Exclusive-Locks共享锁和排它锁"><a href="#Shared-and-Exclusive-Locks共享锁和排它锁" class="headerlink" title="Shared and Exclusive Locks共享锁和排它锁"></a>Shared and Exclusive Locks共享锁和排它锁</h4><p><code>InnoDB</code> implements standard row-level locking where there are two types of locks, <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_shared_lock">shared (<code>S</code>) locks</a> and <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_exclusive_lock">exclusive (<code>X</code>) locks</a>.</p>
<p>InnoDB实现标准行级别锁,其包含两种:共享(s)锁,排它(x)锁</p>
<ul>
<li>A <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_shared_lock">shared (<code>S</code>) lock</a> permits the transaction that holds the lock to read a row.</li>
<li>共享锁允许事务在读取一行数据时持有该锁</li>
<li>An <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_exclusive_lock">exclusive (<code>X</code>) lock</a> permits the transaction that holds the lock to update or delete a row.</li>
<li>排它锁允许事务更新或删除一行数据时持有该锁</li>
</ul>
<p>If transaction <code>T1</code> holds a shared (<code>S</code>) lock on row <code>r</code>, then requests from some distinct transaction <code>T2</code> for a lock on row <code>r</code> are handled as follows:</p>
<p>如果T1事务拿到r行的s锁，那么其他事务T2请求持有r行锁的逻辑如下:</p>
<ul>
<li>A request by <code>T2</code> for an <code>S</code> lock can be granted immediately. As a result, both <code>T1</code> and <code>T2</code> hold an <code>S</code> lock on <code>r</code>.</li>
<li>T2请求的是S锁可以被立即允许，最终，T1和T2持有r行的S锁</li>
<li>A request by <code>T2</code> for an <code>X</code> lock cannot be granted immediately.</li>
<li>T2请求X锁不能被立刻允许</li>
</ul>
<p>If a transaction <code>T1</code> holds an exclusive (<code>X</code>) lock on row <code>r</code>, a request from some distinct transaction <code>T2</code> for a lock of either type on <code>r</code> cannot be granted immediately. Instead, transaction <code>T2</code> has to wait for transaction <code>T1</code> to release its lock on row <code>r</code>.</p>
<p>如果T1事务持有r行的X锁，T2事务在r行请求的任何锁都不能立即授权，在T1事务释放r行上的锁之前，T2回一直等待。</p>
<h4 id="Intention-Locks意向锁"><a href="#Intention-Locks意向锁" class="headerlink" title="Intention Locks意向锁"></a>Intention Locks意向锁</h4><p><code>InnoDB</code> supports <em>multiple granularity locking</em> which permits coexistence of row locks and table locks. For example, a statement such as <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/lock-tables.html"><code>LOCK TABLES ... WRITE</code></a> takes an exclusive lock (an <code>X</code> lock) on the specified table. To make locking at multiple granularity levels practical, <code>InnoDB</code> uses <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_intention_lock">intention locks<i class="fas fa-external-link-alt"></i></a>. Intention locks are table-level locks that indicate which type of lock (shared or exclusive) a transaction requires later for a row in a table. There are two types of intention locks:</p>
<p>InnoDB支持多粒度锁来允许行锁和表锁共存。例如，<code>LOCK TABLES ... WRITE</code>会在特定表上加上一个x锁，为了使多粒度锁好使，InnoDB使用意向锁。意向锁是行级别锁，用于指示一个事务接下来需要在表中的某一行需要获取的锁类型(s或x)，有两种意向锁(简单说，事务获取一行的s锁或x锁之前，要先获取意向锁)</p>
<ul>
<li>An <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_intention_shared_lock">intention shared lock<i class="fas fa-external-link-alt"></i></a> (<code>IS</code>) indicates that a transaction intends to set a <em>shared</em> lock on individual rows in a table.</li>
<li>意向共享锁(IS)表示一个事务想在表中一个独立行上设置一个共享锁</li>
<li>An <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_intention_exclusive_lock">intention exclusive lock<i class="fas fa-external-link-alt"></i></a> (<code>IX</code>) indicates that a transaction intends to set an exclusive lock on individual rows in a table.</li>
<li>意向排它锁表示一个事务意图在表中一个独立行上设置一个排它锁</li>
</ul>
<p>For example, <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/select.html"><code>SELECT ... LOCK IN SHARE MODE</code></a> sets an <code>IS</code> lock, and <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/select.html"><code>SELECT ... FOR UPDATE</code></a> sets an <code>IX</code> lock.</p>
<p>例如:<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/select.html"><code>SELECT ... LOCK IN SHARE MODE</code></a> 设置一个意向共享锁, and <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/select.html"><code>SELECT ... FOR UPDATE</code></a> 设置一个意向排它锁.</p>
<p>The intention locking protocol is as follows:</p>
<p>意向锁有以下约定</p>
<ul>
<li>Before a transaction can acquire a shared lock on a row in a table, it must first acquire an <code>IS</code> lock or stronger on the table.</li>
<li>一个事务获取表中一行记录的共享锁前，必须先获取该表的意向共享锁(或更强的锁)</li>
<li>Before a transaction can acquire an exclusive lock on a row in a table, it must first acquire an <code>IX</code> lock on the table.</li>
<li>一个事务获取表中一行记录的排它锁前，必须先获取该表的意向排它锁</li>
</ul>
<p>Table-level lock type compatibility is summarized in the following <strong>matrix</strong>.</p>
<p>表级别锁类型兼容性在下面汇总表中总结</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"><code>X</code></th>
<th align="left"><code>IX</code></th>
<th align="left"><code>S</code></th>
<th align="left"><code>IS</code></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>X</code></td>
<td align="left">Conflict</td>
<td align="left">Conflict</td>
<td align="left">Conflict</td>
<td align="left">Conflict</td>
</tr>
<tr>
<td align="left"><code>IX</code></td>
<td align="left">Conflict</td>
<td align="left">Compatible</td>
<td align="left">Conflict</td>
<td align="left">Compatible</td>
</tr>
<tr>
<td align="left"><code>S</code></td>
<td align="left">Conflict</td>
<td align="left">Conflict</td>
<td align="left">Compatible</td>
<td align="left">Compatible</td>
</tr>
<tr>
<td align="left"><code>IS</code></td>
<td align="left">Conflict</td>
<td align="left">Compatible</td>
<td align="left">Compatible</td>
<td align="left">Compatible</td>
</tr>
</tbody></table>
<p>A lock is granted to a requesting transaction if it is compatible with existing locks, but not if it conflicts with existing locks. A transaction waits until the conflicting existing lock is released. If a lock request conflicts with an existing lock and cannot be granted because it would cause <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/glossary.html#glos_deadlock">deadlock<i class="fas fa-external-link-alt"></i></a>, an error occurs.</p>
<p>事务请求锁类型与已存在锁类型兼容时，锁就给了那个请求事务，但如果与已存在锁类型不兼容，就会有冲突，事务在已存在冲突锁释放前会一直等待。如果一个锁请求会导致死锁，那它不能被授予，并会弹出来错误</p>
<p>Intention locks do not block anything except full table requests (for example, <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/lock-tables.html"><code>LOCK TABLES ... WRITE</code></a>). The main purpose of intention locks is to show that someone is locking a row, or going to lock a row in the table.</p>
<p>除了全表请求(LOCK TABLES … WRITE),意向锁不会阻塞任何东西，其主要目的就是说明一些请求正打算或正在锁定表中的一行记录</p>
<p>Transaction data for an intention lock appears similar to the following in <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/show-engine.html"><code>SHOW ENGINE INNODB STATUS</code></a> and <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-standard-monitor.html">InnoDB monitor<i class="fas fa-external-link-alt"></i></a> output:</p>
<p>意向锁的事务数据在 <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/show-engine.html"><code>SHOW ENGINE INNODB STATUS</code></a> and <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-standard-monitor.html">InnoDB monitor<i class="fas fa-external-link-alt"></i></a> 输出时会出现类似输出</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">TABLE</span> LOCK <span class="keyword">table</span> `test`.`t` trx id <span class="number">10080</span> lock mode IX</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">#session1开启事务，对表中某一行数据加共享读锁</span><br><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; select * from score where id = 1 lock in share mode;</span><br><span class="line">+------+------+------+---------+---------+</span><br><span class="line">| id   | name | math | english | chinese |</span><br><span class="line">+------+------+------+---------+---------+</span><br><span class="line">|    1 | lisi |   67 |      88 |      95 |</span><br><span class="line">+------+------+------+---------+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line">#session2执行获取表x锁,可以看到session2会一直锁定</span><br><span class="line">mysql&gt; lock tables score write;</span><br><span class="line">^C^C -- query aborted</span><br><span class="line">ERROR 1317 (70100): Query execution was interrupted</span><br><span class="line">#session2执行获取表s锁，可以获取到</span><br><span class="line">mysql&gt; lock tables score read;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">#session2执行获取表x锁时执行show engine innodb status并没有看到有上面说的IS锁</span><br><span class="line"></span><br><span class="line">mysql&gt; show engine innodb status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">  Type: InnoDB</span><br><span class="line">  Name: </span><br><span class="line">Status: </span><br><span class="line">=====================================</span><br><span class="line">2022-02-21 18:48:48 0x1706ff000 INNODB MONITOR OUTPUT</span><br><span class="line">=====================================</span><br><span class="line">Per second averages calculated from the last 40 seconds</span><br><span class="line">-----------------</span><br><span class="line">BACKGROUND THREAD</span><br><span class="line">-----------------</span><br><span class="line">srv_master_thread loops: 11 srv_active, 0 srv_shutdown, 48921 srv_idle</span><br><span class="line">srv_master_thread log flush and writes: 48932</span><br><span class="line">----------</span><br><span class="line">SEMAPHORES</span><br><span class="line">----------</span><br><span class="line">OS WAIT ARRAY INFO: reservation count 60</span><br><span class="line">OS WAIT ARRAY INFO: signal count 57</span><br><span class="line">RW-shared spins 0, rounds 33, OS waits 16</span><br><span class="line">RW-excl spins 0, rounds 0, OS waits 0</span><br><span class="line">RW-sx spins 0, rounds 0, OS waits 0</span><br><span class="line">Spin rounds per wait: 33.00 RW-shared, 0.00 RW-excl, 0.00 RW-sx</span><br><span class="line">------------</span><br><span class="line">TRANSACTIONS</span><br><span class="line">------------</span><br><span class="line">Trx id counter 10779</span><br><span class="line">Purge done for trx&#x27;s n:o &lt; 10779 undo n:o &lt; 0 state: running but idle</span><br><span class="line">History list length 0</span><br><span class="line">LIST OF TRANSACTIONS FOR EACH SESSION:</span><br><span class="line">---TRANSACTION 281480566246072, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">--------</span><br><span class="line">FILE I/O</span><br><span class="line">--------</span><br><span class="line">I/O thread 0 state: waiting for i/o request (insert buffer thread)</span><br><span class="line">I/O thread 1 state: waiting for i/o request (log thread)</span><br><span class="line">I/O thread 2 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 3 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 4 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 5 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 6 state: waiting for i/o request (write thread)</span><br><span class="line">I/O thread 7 state: waiting for i/o request (write thread)</span><br><span class="line">I/O thread 8 state: waiting for i/o request (write thread)</span><br><span class="line">I/O thread 9 state: waiting for i/o request (write thread)</span><br><span class="line">Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,</span><br><span class="line"> ibuf aio reads:, log i/o&#x27;s:, sync i/o&#x27;s:</span><br><span class="line">Pending flushes (fsync) log: 0; buffer pool: 0</span><br><span class="line">1870 OS file reads, 142 OS file writes, 74 OS fsyncs</span><br><span class="line">0.00 reads/s, 0 avg bytes/read, 0.15 writes/s, 0.12 fsyncs/s</span><br><span class="line">-------------------------------------</span><br><span class="line">INSERT BUFFER AND ADAPTIVE HASH INDEX</span><br><span class="line">-------------------------------------</span><br><span class="line">Ibuf: size 1, free list len 10, seg size 12, 0 merges</span><br><span class="line">merged operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">discarded operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">0.00 hash searches/s, 0.00 non-hash searches/s</span><br><span class="line">---</span><br><span class="line">LOG</span><br><span class="line">---</span><br><span class="line">Log sequence number 12618858088</span><br><span class="line">Log flushed up to   12618858088</span><br><span class="line">Pages flushed up to 12618858088</span><br><span class="line">Last checkpoint at  12618858079</span><br><span class="line">0 pending log flushes, 0 pending chkp writes</span><br><span class="line">51 log i/o&#x27;s done, 0.07 log i/o&#x27;s/second</span><br><span class="line">----------------------</span><br><span class="line">BUFFER POOL AND MEMORY</span><br><span class="line">----------------------</span><br><span class="line">Total large memory allocated 137428992</span><br><span class="line">Dictionary memory allocated 214563</span><br><span class="line">Buffer pool size   8192</span><br><span class="line">Free buffers       6330</span><br><span class="line">Database pages     1862</span><br><span class="line">Old database pages 706</span><br><span class="line">Modified db pages  0</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 0, not young 0</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 1826, created 36, written 73</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">Buffer pool hit rate 1000 / 1000, young-making rate 0 / 1000 not 0 / 1000</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 1862, unzip_LRU len: 0</span><br><span class="line">I/O sum[0]:cur[0], unzip sum[0]:cur[0]</span><br><span class="line">--------------</span><br><span class="line">ROW OPERATIONS</span><br><span class="line">--------------</span><br><span class="line">0 queries inside InnoDB, 0 queries in queue</span><br><span class="line">0 read views open inside InnoDB</span><br><span class="line">Process ID=82927, Main thread ID=6175535104, state: sleeping</span><br><span class="line">Number of rows inserted 0, updated 4, deleted 0, read 68</span><br><span class="line">0.00 inserts/s, 0.00 updates/s, 0.00 deletes/s, 0.00 reads/s</span><br><span class="line">----------------------------</span><br><span class="line">END OF INNODB MONITOR OUTPUT</span><br><span class="line">============================</span><br><span class="line"></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="Record-Locks"><a href="#Record-Locks" class="headerlink" title="Record Locks"></a>Record Locks</h4><p>A record lock is a lock on an index record. For example, <code>SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE;</code> prevents any other transaction from inserting, updating, or deleting rows where the value of <code>t.c1</code> is <code>10</code>.</p>
<p>记录锁是在一个索引记录上加的锁，例如<code>SELECT c1 FROM t WHERE c1 = 10 FOR UPDATE;</code>会阻止其他事务对cl=10的记录执行DML语句</p>
<p>Record locks always lock index records, even if a table is defined with no indexes. For such cases, <code>InnoDB</code> creates a hidden clustered index and uses this index for record locking. See <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-index-types.html">Section 14.6.2.1, “Clustered and Secondary Indexes”<i class="fas fa-external-link-alt"></i></a>.</p>
<p>行级了锁总是锁索引数据，即便一个表没有任何索引(在这种情况下，InnoDB创建一个隐藏聚簇索引并且用于记录锁)。</p>
<p>Transaction data for a record lock appears similar to the following in <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/show-engine.html"><code>SHOW ENGINE INNODB STATUS</code></a> and <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-standard-monitor.html">InnoDB monitor<i class="fas fa-external-link-alt"></i></a> output:</p>
<p>一个记录锁的事务数据格式如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id <span class="number">58</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> index `<span class="keyword">PRIMARY</span>` <span class="keyword">of</span> <span class="keyword">table</span> `test`.`t`</span><br><span class="line">trx id <span class="number">10078</span> lock_mode X locks rec but <span class="keyword">not</span> gap</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">3</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">8000000</span>a; <span class="keyword">asc</span>     ;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">00000000274</span>f; <span class="keyword">asc</span>     <span class="string">&#x27;O;;</span></span><br><span class="line"><span class="string"> 2: len 7; hex b60000019d0110; asc        ;;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">*************************** 1. row ***************************</span><br><span class="line">  Type: InnoDB</span><br><span class="line">  Name: </span><br><span class="line">Status: </span><br><span class="line">=====================================</span><br><span class="line">2022-02-21 21:02:16 0x17074f000 INNODB MONITOR OUTPUT</span><br><span class="line">=====================================</span><br><span class="line">Per second averages calculated from the last 3 seconds</span><br><span class="line">-----------------</span><br><span class="line">BACKGROUND THREAD</span><br><span class="line">-----------------</span><br><span class="line">srv_master_thread loops: 13 srv_active, 0 srv_shutdown, 52890 srv_idle</span><br><span class="line">srv_master_thread log flush and writes: 52903</span><br><span class="line">----------</span><br><span class="line">SEMAPHORES</span><br><span class="line">----------</span><br><span class="line">OS WAIT ARRAY INFO: reservation count 60</span><br><span class="line">OS WAIT ARRAY INFO: signal count 57</span><br><span class="line">RW-shared spins 0, rounds 33, OS waits 16</span><br><span class="line">RW-excl spins 0, rounds 0, OS waits 0</span><br><span class="line">RW-sx spins 0, rounds 0, OS waits 0</span><br><span class="line">Spin rounds per wait: 33.00 RW-shared, 0.00 RW-excl, 0.00 RW-sx</span><br><span class="line">------------</span><br><span class="line">TRANSACTIONS</span><br><span class="line">------------</span><br><span class="line">Trx id counter 10781</span><br><span class="line">Purge done for trx&#x27;s n:o &lt; 10779 undo n:o &lt; 0 state: running but idle</span><br><span class="line">History list length 0</span><br><span class="line">LIST OF TRANSACTIONS FOR EACH SESSION:</span><br><span class="line">---TRANSACTION 281480566246072, not started</span><br><span class="line">0 lock struct(s), heap size 1136, 0 row lock(s)</span><br><span class="line">---TRANSACTION 10780, ACTIVE 36 sec</span><br><span class="line">2 lock struct(s), heap size 1136, 5 row lock(s)</span><br><span class="line">MySQL thread id 5, OS thread handle 6181351424, query id 192 localhost root</span><br><span class="line">--------</span><br><span class="line">FILE I/O</span><br><span class="line">--------</span><br><span class="line">I/O thread 0 state: waiting for i/o request (insert buffer thread)</span><br><span class="line">I/O thread 1 state: waiting for i/o request (log thread)</span><br><span class="line">I/O thread 2 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 3 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 4 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 5 state: waiting for i/o request (read thread)</span><br><span class="line">I/O thread 6 state: waiting for i/o request (write thread)</span><br><span class="line">I/O thread 7 state: waiting for i/o request (write thread)</span><br><span class="line">I/O thread 8 state: waiting for i/o request (write thread)</span><br><span class="line">I/O thread 9 state: waiting for i/o request (write thread)</span><br><span class="line">Pending normal aio reads: [0, 0, 0, 0] , aio writes: [0, 0, 0, 0] ,</span><br><span class="line"> ibuf aio reads:, log i/o&#x27;s:, sync i/o&#x27;s:</span><br><span class="line">Pending flushes (fsync) log: 0; buffer pool: 0</span><br><span class="line">1870 OS file reads, 145 OS file writes, 74 OS fsyncs</span><br><span class="line">0.00 reads/s, 0 avg bytes/read, 0.00 writes/s, 0.00 fsyncs/s</span><br><span class="line">-------------------------------------</span><br><span class="line">INSERT BUFFER AND ADAPTIVE HASH INDEX</span><br><span class="line">-------------------------------------</span><br><span class="line">Ibuf: size 1, free list len 10, seg size 12, 0 merges</span><br><span class="line">merged operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">discarded operations:</span><br><span class="line"> insert 0, delete mark 0, delete 0</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">Hash table size 34679, node heap has 0 buffer(s)</span><br><span class="line">0.00 hash searches/s, 0.00 non-hash searches/s</span><br><span class="line">---</span><br><span class="line">LOG</span><br><span class="line">---</span><br><span class="line">Log sequence number 12618858088</span><br><span class="line">Log flushed up to   12618858088</span><br><span class="line">Pages flushed up to 12618858088</span><br><span class="line">Last checkpoint at  12618858079</span><br><span class="line">0 pending log flushes, 0 pending chkp writes</span><br><span class="line">51 log i/o&#x27;s done, 0.00 log i/o&#x27;s/second</span><br><span class="line">----------------------</span><br><span class="line">BUFFER POOL AND MEMORY</span><br><span class="line">----------------------</span><br><span class="line">Total large memory allocated 137428992</span><br><span class="line">Dictionary memory allocated 214563</span><br><span class="line">Buffer pool size   8192</span><br><span class="line">Free buffers       6330</span><br><span class="line">Database pages     1862</span><br><span class="line">Old database pages 706</span><br><span class="line">Modified db pages  0</span><br><span class="line">Pending reads      0</span><br><span class="line">Pending writes: LRU 0, flush list 0, single page 0</span><br><span class="line">Pages made young 0, not young 0</span><br><span class="line">0.00 youngs/s, 0.00 non-youngs/s</span><br><span class="line">Pages read 1826, created 36, written 76</span><br><span class="line">0.00 reads/s, 0.00 creates/s, 0.00 writes/s</span><br><span class="line">No buffer pool page gets since the last printout</span><br><span class="line">Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/s</span><br><span class="line">LRU len: 1862, unzip_LRU len: 0</span><br><span class="line">I/O sum[0]:cur[0], unzip sum[0]:cur[0]</span><br><span class="line">--------------</span><br><span class="line">ROW OPERATIONS</span><br><span class="line">--------------</span><br><span class="line">0 queries inside InnoDB, 0 queries in queue</span><br><span class="line">0 read views open inside InnoDB</span><br><span class="line">Process ID=82927, Main thread ID=6175535104, state: sleeping</span><br><span class="line">Number of rows inserted 5, updated 4, deleted 0, read 85</span><br><span class="line">0.00 inserts/s, 0.00 updates/s, 0.00 deletes/s, 0.00 reads/s</span><br><span class="line">----------------------------</span><br><span class="line">END OF INNODB MONITOR OUTPUT</span><br><span class="line">============================</span><br><span class="line"></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure>





<h4 id="Gap-Locks"><a href="#Gap-Locks" class="headerlink" title="Gap Locks"></a>Gap Locks</h4><p>A gap lock is a lock on a gap between index records, or a lock on the gap before the first or after the last index record. For example, <code>SELECT c1 FROM t WHERE c1 BETWEEN 10 and 20 FOR UPDATE;</code> prevents other transactions from inserting a value of <code>15</code> into column <code>t.c1</code>, whether or not there was already any such value in the column, because the gaps between all existing values in the range are locked.</p>
<p>间隙锁是指在索引记录之间的锁，或在第一条索引记录的前面，或在最后一个索引记录的后面。例如，<code>SELECT c1 FROM t WHERE c1 BETWEEN 10 and 20 FOR UPDATE;</code>阻止其他事务插入一条cl=15的记录，无论字段中是否已经有15这个值的记录，因为范围内的任何值之间的间隙都被锁定了。</p>
<p>A gap might span a single index value, multiple index values, or even be empty.</p>
<p>一个间隙可能横跨一个单个索引值，多个索引值或0个索引</p>
<p>Gap locks are part of the tradeoff between performance and concurrency, and are used in <strong>some</strong> transaction isolation levels <strong>and not others.</strong></p>
<p>间隙锁是性能和并发的综合权衡的产物，被用于一些事务隔离级别，而不是其他级别</p>
<p>Gap locking is not needed for statements that lock rows using a unique index to search for a unique row. (This does not include the case that the search condition includes only some columns of a multiple-column unique index; in that case, gap locking does occur.) For example, if the <code>id</code> column has a unique index, the following statement uses only an index-record lock for the row having <code>id</code> value 100 and it does not matter whether other sessions insert rows in the preceding gap:</p>
<p>如果使用唯一索引查询唯一行，不需要使用间隙锁(不包括搜索条件为联合唯一索引的部分字段的情况;在这种情况，也会出现间隙锁)。例如，如果id字段有唯一索引，下面的语句仅对id为100的行使用索引记录锁，也不care其他线程是否在间隙的前面插入行</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> child <span class="keyword">WHERE</span> id <span class="operator">=</span> <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p>If <code>id</code> is not indexed or has a nonunique index, the statement does lock the preceding gap.</p>
<p>如果id不被索引或不是唯一索引，这个语句会锁住前面的间隙</p>
<p>It is also worth noting here that conflicting locks can be held on a gap by different transactions. For example, transaction A can hold a shared gap lock (gap S-lock) on a gap while transaction B holds an exclusive gap lock (gap X-lock) on the same gap. The reason conflicting gap locks are allowed is that if a record is purged from an index, the gap locks held on the record by different transactions must be merged.</p>
<p>需要注意:一个间隙上的冲突锁可以被不同事物拿到。例如:一个间隙，其共享间隙锁可以被事务A拿到，与此同时，事务B可以持有它的独占间隙锁。冲突间隙锁被允许的原因是:如果索引中一条记录被清除，不同事务持有这条记录上的间隙锁一定会被合并(没看懂)</p>
<p>Gap locks in <code>InnoDB</code> are “purely inhibitive”, which means that their only purpose is to prevent other transactions from inserting to the gap. Gap locks can co-exist. A gap lock taken by one transaction does not prevent another transaction from taking a gap lock on the same gap. There is no difference between shared and exclusive gap locks. They do not conflict with each other, and they perform the same function.</p>
<p>InnoDB中的间隙锁是”纯抑制性”的，即它的目的是阻止其他事务向间隙中写入数据，间隙锁可以同时存在。一个事务持有间隙锁不会阻止其他事务在同一个间隙上获取间隙锁。共享和独占间隙锁没有什么不同，它们不互相冲突，并且有相同功能</p>
<p>Gap locking can be disabled explicitly. This occurs if you change the transaction isolation level to <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_read-committed"><code>READ COMMITTED</code></a> or enable the <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_locks_unsafe_for_binlog"><code>innodb_locks_unsafe_for_binlog</code></a> system variable (which is now deprecated). In this case, gap locking is disabled for searches and index scans and is used only for foreign-key constraint checking and duplicate-key checking.</p>
<p>如果修改事务隔离级别为READ_COMMITTED或允许innodb_locks_unsafe_for_binlog系统参数(已被弃用)，间隙锁可以被明确禁用.这种情况下，间隙锁仅用于外键限制检查和重复key检查，不会用于搜索和索引扫描</p>
<p>There are also other effects of using the <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_read-committed"><code>READ COMMITTED</code></a> isolation level or enabling <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_locks_unsafe_for_binlog"><code>innodb_locks_unsafe_for_binlog</code></a>. Record locks for nonmatching rows are released after MySQL has evaluated the <code>WHERE</code> condition. For <code>UPDATE</code> statements, <code>InnoDB</code> does a “semi-consistent” read, such that it returns the latest committed version to MySQL so that MySQL can determine whether the row matches the <code>WHERE</code> condition of the <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/update.html"><code>UPDATE</code></a>.</p>
<p>使用READ COMMITTED隔离级别或打开innodb_locks_unsafe_for_binlog会有其他影响，当MySQL执行where条件sql后，未被匹配的行记录锁被释放。对于UPDATE语句,InnoDB执行半一致性读取，这样它返回了最近一次提交的版本到MySQL，所以MySQL能确定这个行是否符合update的where条件</p>
<h4 id="Next-Key-Locks"><a href="#Next-Key-Locks" class="headerlink" title="Next-Key Locks"></a>Next-Key Locks</h4><p>A next-key lock is a combination of a record lock on the index record and a gap lock on the gap before the index record.</p>
<p>next-key锁是索引上的行记录锁和索引记录前的间隙上的间隙锁的结合</p>
<p><code>InnoDB</code> performs row-level locking in such a way that when it searches or scans a table index, it sets shared or exclusive locks on the index records it encounters. Thus, the row-level locks are actually index-record locks. A next-key lock on an index record also affects the “gap” before that index record. That is, a next-key lock is an index-record lock plus a gap lock on the gap preceding the index record. If one session has a shared or exclusive lock on record <code>R</code> in an index, another session cannot insert a new index record in the gap immediately before <code>R</code> in the index order.</p>
<p>InnoDB以如下方式执行行级别锁:当它搜索或扫描到一个表索引，它会对遇到的索引记录设置共享或独占锁。因此，行级别锁实际是索引记录的锁.一个索引记录上的next-key锁也影响着歌索引记录之前的间隙。也就是说，一个next-key锁是一个索引记录锁+这个索引前面的间隙锁。如果一个会话有记录R上索引上的共享或独占锁，其他会话不能在R索引记录的前面立刻插入一个新的索引记录。</p>
<p>Suppose that an index contains the values 10, 11, 13, and 20. The possible next-key locks for this index cover the following intervals, where a round bracket denotes exclusion of the interval endpoint and a square bracket denotes inclusion of the endpoint:</p>
<p>假定一个索引包含值10,11,13,20,这个索引的next-key可能涵盖以下区间，其中圆括号表示排除区间的端点，方括号表示包含端点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">负无穷到10]</span><br><span class="line">(negative infinity, 10]</span><br><span class="line">(10, 11]</span><br><span class="line">(11, 13]</span><br><span class="line">(13, 20]</span><br><span class="line">(20, positive infinity)</span><br><span class="line">(20到正无穷</span><br></pre></td></tr></table></figure>

<p>For the last interval, the next-key lock locks the gap above the largest value in the index and the “supremum” pseudo-record having a value higher than any value actually in the index. The supremum is not a real index record, so, in effect, this next-key lock locks only the gap following the largest index value.</p>
<p>在最后一个区间，next-key锁锁住索引最大值之上和正无穷数，正无穷数不是一个索引数据，所以，next-key锁实际上锁的是索引数据的最大值的后面部分</p>
<p>By default, <code>InnoDB</code> operates in <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_repeatable-read"><code>REPEATABLE READ</code></a> transaction isolation level. In this case, <code>InnoDB</code> uses next-key locks for searches and index scans, which prevents phantom rows (see <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-next-key-locking.html">Section 14.7.4, “Phantom Rows”<i class="fas fa-external-link-alt"></i></a>).</p>
<p>InnoDB在REPEATABLE READ事务级别上操作，在这种情况下，InnoDB在搜索和扫描索引时使用next-key锁阻止幻读读的发生</p>
<p>Transaction data for a next-key lock appears similar to the following in <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/show-engine.html"><code>SHOW ENGINE INNODB STATUS</code></a> and <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-standard-monitor.html">InnoDB monitor<i class="fas fa-external-link-alt"></i></a> output:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id <span class="number">58</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> index `<span class="keyword">PRIMARY</span>` <span class="keyword">of</span> <span class="keyword">table</span> `test`.`t`</span><br><span class="line">trx id <span class="number">10080</span> lock_mode X</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">8</span>; hex <span class="number">73757072656</span>d756d; <span class="keyword">asc</span> supremum;;</span><br><span class="line"></span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">3</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">8000000</span>a; <span class="keyword">asc</span>     ;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">00000000274</span>f; <span class="keyword">asc</span>     <span class="string">&#x27;O;;</span></span><br><span class="line"><span class="string"> 2: len 7; hex b60000019d0110; asc        ;;</span></span><br></pre></td></tr></table></figure>

<h4 id="Insert-Intention-Locks"><a href="#Insert-Intention-Locks" class="headerlink" title="Insert Intention Locks"></a>Insert Intention Locks</h4><p>An insert intention lock is a type of gap lock set by <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/insert.html"><code>INSERT</code></a> operations prior to row insertion. This lock signals the intent to insert in such a way that multiple transactions inserting into the same index gap need not wait for each other if they are not inserting at the same position within the gap. Suppose that there are index records with values of 4 and 7. Separate transactions that attempt to insert values of 5 and 6, respectively, each lock the gap between 4 and 7 with insert intention locks prior to obtaining the exclusive lock on the inserted row, but do not block each other because the rows are nonconflicting.</p>
<p>插入意向锁是间隙锁的一种类型，在一行记录被插入前被设置。这个锁标识一种插入方式的意图-多个事务插入同一个索引空袭不会互相等待如果他们插入的是间隙的不同位置。分别尝试插入值 5 和 6 的单独事务，每个在获得插入行的排他锁之前使用插入意向锁锁定 4 和 7 之间的间隙，但不会相互阻塞，因为这些行是不冲突的。</p>
<p>The following example demonstrates a transaction taking an insert intention lock prior to obtaining an exclusive lock on the inserted record. The example involves two clients, A and B.</p>
<p>以下示例演示了在获得插入记录的排他锁之前获取插入意图锁的事务。 该示例涉及两个客户端，A 和 B。</p>
<p>Client A creates a table containing two index records (90 and 102) and then starts a transaction that places an exclusive lock on index records with an ID greater than 100. The exclusive lock includes a gap lock before record 102:</p>
<p>客户端A创建一个表包含两个索引数据，启动事务，在ID大于100的索引记录上创建了一个独占锁，独占锁包含102之前的间隙锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> child (id <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>, <span class="keyword">PRIMARY</span> KEY(id)) ENGINE<span class="operator">=</span>InnoDB;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child (id) <span class="keyword">values</span> (<span class="number">90</span>),(<span class="number">102</span>);</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> child <span class="keyword">WHERE</span> id <span class="operator">&gt;</span> <span class="number">100</span> <span class="keyword">FOR</span> UPDATE;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----+</span></span><br><span class="line"><span class="operator">|</span> id  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">102</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----+</span></span><br></pre></td></tr></table></figure>

<p>Client B begins a transaction to insert a record into the gap. The transaction takes an insert intention lock while it waits to obtain an exclusive lock.</p>
<p>客户端B开启事务向间隙中插入一条记录。事务在等待获取独占锁时设置了一把插入意向锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">START</span> TRANSACTION;</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">INSERT</span> <span class="keyword">INTO</span> child (id) <span class="keyword">VALUES</span> (<span class="number">101</span>);</span><br></pre></td></tr></table></figure>

<p>Transaction data for an insert intention lock appears similar to the following in <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/show-engine.html"><code>SHOW ENGINE INNODB STATUS</code></a> and <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-standard-monitor.html">InnoDB monitor<i class="fas fa-external-link-alt"></i></a> output:</p>
<p>插入意向锁的事务信息与下面情况类似</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">RECORD LOCKS space id <span class="number">31</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> index `<span class="keyword">PRIMARY</span>` <span class="keyword">of</span> <span class="keyword">table</span> `test`.`child`</span><br><span class="line">trx id <span class="number">8731</span> lock_mode X locks gap before rec <span class="keyword">insert</span> intention waiting</span><br><span class="line">Record lock, heap <span class="keyword">no</span> <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">3</span>; compact format; info bits <span class="number">0</span></span><br><span class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">80000066</span>; <span class="keyword">asc</span>    f;;</span><br><span class="line"> <span class="number">1</span>: len <span class="number">6</span>; hex <span class="number">000000002215</span>; <span class="keyword">asc</span>     &quot; ;;</span><br><span class="line"> 2: len 7; hex 9000000172011c; asc     r  ;;...</span><br></pre></td></tr></table></figure>

<h4 id="AUTO-INC-Locks"><a href="#AUTO-INC-Locks" class="headerlink" title="AUTO-INC Locks"></a>AUTO-INC Locks</h4><p>An <code>AUTO-INC</code> lock is a special table-level lock taken by transactions inserting into tables with <code>AUTO_INCREMENT</code> columns. In the simplest case, if one transaction is inserting values into the table, any other transactions must wait to do their own inserts into that table, so that rows inserted by the first transaction receive consecutive primary key values.</p>
<p>The <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_autoinc_lock_mode"><code>innodb_autoinc_lock_mode</code></a> variable controls the algorithm used for auto-increment locking. It allows you to choose how to trade off between predictable sequences of auto-increment values and maximum concurrency for insert operations.</p>
<p>For more information, see <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-auto-increment-handling.html">Section 14.6.1.6, “AUTO_INCREMENT Handling in InnoDB”<i class="fas fa-external-link-alt"></i></a>.</p>
<p>自增锁是一个特殊的表级别锁，在事务插入表记录时使用自增字段时。最简单情况下，如果一个事务正在向表中插入一条数据，另外一个事务必须等待，以便第一个事务接收到连续的主键值</p>
<p>innodb_autoinc_lock_mode参数控制用于自增锁的算法，它允许你选择如何在可预测的自动递增序列值和插入操作最大并发性之间进行权衡</p>
<h4 id="Predicate-Locks-for-Spatial-Indexes"><a href="#Predicate-Locks-for-Spatial-Indexes" class="headerlink" title="Predicate Locks for Spatial Indexes"></a>Predicate Locks for Spatial Indexes</h4><p>空间索引的谓词锁</p>
<p><code>InnoDB</code> supports <code>SPATIAL</code> indexing of columns containing spatial data (see <a class="link" target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/optimizing-spatial-analysis.html">Section 11.4.8, “Optimizing Spatial Analysis”<i class="fas fa-external-link-alt"></i></a>).</p>
<p>InnoDB支持在包含空间数据上的字段建立空间索引</p>
<p>To handle locking for operations involving <code>SPATIAL</code> indexes, next-key locking does not work well to support <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_repeatable-read"><code>REPEATABLE READ</code></a> or <a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/5.7/en/innodb-transaction-isolation-levels.html#isolevel_serializable"><code>SERIALIZABLE</code></a> transaction isolation levels. There is no absolute ordering concept in multidimensional data, so it is not clear which is the “next” key.</p>
<p>为了处理在空间索引上的锁操作，next-key锁不擅长可重复读和串型事务隔离级别。在多维度数据上没有一个明确的排序概念，所以很难确定哪个是next key</p>
<p>To enable support of isolation levels for tables with <code>SPATIAL</code> indexes, <code>InnoDB</code> uses predicate locks. A <code>SPATIAL</code> index contains minimum bounding rectangle (MBR) values, so <code>InnoDB</code> enforces consistent read on the index by setting a predicate lock on the MBR value used for a query. Other transactions cannot insert or modify a row that would match the query condition.</p>
<p>为了支持空间索引表上的隔离级别，InnoDB使用为此锁。<code>SPATIAL</code> 索引包含最小边界矩形 (MBR) 值，因此 <code>InnoDB</code> 通过在用于查询的 MBR 值上设置谓词锁定来强制对索引进行一致读取。 其他事务无法插入或修改与查询条件匹配的行。(没看懂，跳过)</p>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/MySQL/">#MySQL</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/InnoDB/">#InnoDB</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E4%BA%8B%E5%8A%A1/">#事务</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/%E9%94%81%E6%9C%BA%E5%88%B6/">#锁机制</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2022/02/25/Docker/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Docker</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2022/02/13/MYSQL%E9%AB%98%E7%BA%A7/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">MYSQL高级</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;评论</i>
    </div>
    

        
            
    <div id="gitalk-container"></div>
    <script 
            src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
    <script >

        function loadGitalk() {
            let __gitalk__pathname = decodeURI(location.pathname);
            const __gitalk__pathnameLength = __gitalk__pathname.length;
            const __gitalk__pathnameMaxLength = 50;
            if (__gitalk__pathnameLength > __gitalk__pathnameMaxLength) {
                __gitalk__pathname = __gitalk__pathname.substring(0, __gitalk__pathnameMaxLength - 3) + '...';
            }

            try {
                Gitalk && new Gitalk({
                    clientID: '863fbb8458b81279c355',
                    clientSecret: 'de73deafd00d910696772359a03ee417eca8e244',
                    repo: 'chaoqiang6.github.io',
                    owner: 'chaoqiang6',
                    admin: ['chaoqiang6'],
                    id: __gitalk__pathname,
                    language: 'zh-CN'
                }).render('gitalk-container');

            } catch (e) {
                window.Gitalk = null;
            }
        }

        if ('false') {
            const loadGitalkTimeout = setTimeout(() => {
                loadGitalk();
                clearTimeout(loadGitalkTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadGitalk);
        }
    </script>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">chaoqiang.qiu</a>
        </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%96%87%E6%A1%A3"><span class="nav-text">相关文档</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#InnoDB-Locking"><span class="nav-text">InnoDB Locking</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Shared-and-Exclusive-Locks%E5%85%B1%E4%BA%AB%E9%94%81%E5%92%8C%E6%8E%92%E5%AE%83%E9%94%81"><span class="nav-text">Shared and Exclusive Locks共享锁和排它锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Intention-Locks%E6%84%8F%E5%90%91%E9%94%81"><span class="nav-text">Intention Locks意向锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Record-Locks"><span class="nav-text">Record Locks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Gap-Locks"><span class="nav-text">Gap Locks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Next-Key-Locks"><span class="nav-text">Next-Key Locks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Insert-Intention-Locks"><span class="nav-text">Insert Intention Locks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AUTO-INC-Locks"><span class="nav-text">AUTO-INC Locks</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Predicate-Locks-for-Spatial-Indexes"><span class="nav-text">Predicate Locks for Spatial Indexes</span></a></li></ol></li></ol></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
